---

- name: Copy splunk rpm
  copy:
    src: files/splunk-8.1.3-63079c59e632-linux-2.6-x86_64.rpm
    dest: /tmp/splunk.rpm

- name: Install rpm splunk
  shell: rpm -i /tmp/splunk.rpm
  ignore_errors: true
  register: reboot_required_file

- name: set permission directory splunk
  file:
    path: /opt/splunk/
    state: directory
    owner: splunk
    group: splunk
    mode: '0750'
  when: reboot_required_file.changed

#iptables -I INPUT 1 -p tcp --dport 8000 -j ACCEPT
- name: Insert a rule port 8000 (Splunk interface) open in firewall
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 8000
    jump: ACCEPT
    action: insert
    rule_num: 1

- name: Insert a rule port 5044 (logstash) open in firewall
  iptables:
    chain: INPUT
    protocol: tcp
    destination_port: 5044
    jump: ACCEPT
    action: insert
    rule_num: 2

# This will apply to all loaded/active IPv4 tables.
# ansible-galaxy collection install community.general
- name: Save current state of the firewall in system file
  community.general.iptables_state:
    state: saved
    path: /etc/sysconfig/iptables

- name: Copy config user admin splunk
  copy:
    src: files/user.conf
    dest: /opt/splunk/etc/system/local/user-seed.conf
    owner: splunk
    group: splunk
  when: reboot_required_file.changed

- name: Accept license
  shell: /opt/splunk/bin/splunk start --accept-license --answer-yes --no-prompt
  become: yes
  become_method: su
  become_user: splunk
  when: reboot_required_file.changed

- name: Enable service splunk
  shell: /opt/splunk/bin/splunk enable boot-start -user splunk
  when: reboot_required_file.changed

- name: Reboot the box if kernel updated
  reboot:
    msg: "Reboot initiated by Ansible for apply config splunk"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: uptime
  when: reboot_required_file.changed


- name: Validating web port is open
  wait_for:
    host: "{{ ansible_ssh_host }}"
    port: 8000
    delay: 10
    timeout: 30
    state: started
    msg: "splunk web is not running"
  ignore_errors: true
  when: reboot_required_file.changed


- name: set permission directory audir
  file:
    path: /var/log/audit/
    state: directory
    owner: root
    group: splunk
    mode: '0750'
    recurse: yes

- name: set permission directory audir
  file:
    path: /var/log/audit/audit.log
    state: file
    owner: root
    group: splunk
    mode: '0740'


curl -k "https://192.168.1.14:8088/services/collector" \
 -H "Authorization: Splunk d785742f-c9a1-490a-b508-357c21306c3d" \
 -d '{"event": "Hello world"}'

