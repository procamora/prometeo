#jinja2: lstrip_blocks: True

# upstream dashboard {
#     ip_hash;
#     server 10.48.4.14:443;
#     server 10.48.4.15:443;
# }

server {
  listen                        80;
  server_name                   {{ servers[item].name_rp }};
  rewrite ^(.*)                 https://$server_name$1 permanent;
}

server {
  #listen                       443 ssl default_server;
  listen                        443 ssl;
  server_name                   {{ servers[item].name_rp }};

  ssl                           on;
  ssl_certificate               /etc/pki/nginx/{{ servers[item].name_rp }}.crt;
  ssl_certificate_key           /etc/pki/nginx/{{ servers[item].name_rp }}.key;
  ssl_protocols                 TLSv1 TLSv1.1 TLSv1.2;
  ssl_ciphers                   HIGH:!aNULL:!MD5;

  #charset koi8-r
  access_log                    /var/log/nginx/{{ servers[item].name_rp }}.{{ servers[item].port }}.log main;
  error_log                     /var/log/nginx/{{ servers[item].name_rp }}.{{ servers[item].port }}.error.log warn;

  location / {

    proxy_ssl_session_reuse     off;
    proxy_ssl_protocols         TLSv1 TLSv1.1 TLSv1.2;
    proxy_pass                  {{ servers[item].protocol }}://{{ servers[item].name }}:{{ servers[item].port }}/;

    proxy_redirect              off;
    proxy_set_header            Host $host;
    proxy_set_header            X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header            X-Forwarded-Proto $scheme;
    proxy_read_timeout          300;
    proxy_connect_timeout       300;
  }
}

# Alias server name
